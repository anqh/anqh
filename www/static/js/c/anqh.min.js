Anqh=Anqh||{},Anqh.geocoder=null,Anqh.map=null,$.fn.loading=function(loaded){return loaded?$(this).find("div.loading").remove():$(this).append('<div class="loading"></div>'),this},$(function(){var hoverTimeout;$(document).on({mouseenter:function(){var $this=$(this),$popover=$this.data("popover");$popover?$this.popover("show"):hoverTimeout=setTimeout(function(){$.get($this.attr("href")+"/hover",function(response){var $card=$(response);$this.popover({trigger:"manual",html:!0,title:$card.find("header").remove().text().replace("<","&lt;").replace(">","&gt;"),content:$card.html(),container:"body",placement:function(){var offset=$this.offset();return 100>offset.top?"bottom":offset.left>window.innerWidth/2?"left":"right"}}),$this.popover("show")})},500)},mouseleave:function(){var $this=$(this);$this.data("popover")?$this.popover("hide"):clearInterval(hoverTimeout)}},"a.hoverablee"),$("a.comment-delete").each(function(){var $this=$(this);$this.data("action",function(){var comment=$this.attr("href").match(/([0-9]*)\/delete/);comment&&$.get($this.attr("href"),function(){$("#comment-"+comment[1]).slideUp()})})}),$(document).delegate("a.comment-private","click",function(e){e.preventDefault();var href=$(this).attr("href"),comment=href.match(/([0-9]*)\/private/);return comment&&($.get(href,function(){$("#comment-"+comment[1]).addClass("private")}),$(this).fadeOut()),!1}),$(document).delegate("button[name=private-toggle]","click",function(){$("input[name=private]").val(~~$(this).hasClass("active")),$("input[name=comment]").toggleClass("private",~~$(this).hasClass("active")).focus()}),$(document).delegate("section.comments form","submit",function(e){e.preventDefault();var comment=$(this).closest("section.comments");return $.post($(this).attr("action"),$(this).serialize(),function(data){comment.replaceWith(data)}),!1}),$(document).on("click",'a[class*="-delete"]',function(e){e.preventDefault();var callback,$this=$(this),title=$this.data("confirm")||$this.attr("title")||$this.text()||"Are you sure you want to do this?";callback=$this.data("action")?function(){$this.data("action")()}:$this.is("a")?function(){window.location=$this.attr("href")}:function(){$this.parent("form").submit()},0==$("#dialog-confirm").length?($("body").append('<div id="dialog-confirm" title="'+title+'">Are you sure?</div>'),$("#dialog-confirm").dialog({dialogClass:"confirm-delete",modal:!0,close:function(){$(this).remove()},closeText:"☓",buttons:[{text:"✓ Yes, do it!","class":"btn btn-danger",click:function(){$(this).dialog("close"),callback()}},{text:"☓ No, cancel","class":"btn btn-inverse",click:function(){$(this).dialog("close")}}]})):$("#confirm-dialog").dialog("open")}),$(document).on("click","button[name=preview]",function(e){e.preventDefault();var $this=$(this),$form=$this.closest("form"),form=$form.serialize()+"&preview=1",$post=$this.closest("article"),preClass=$this.attr("data-content-class")||"media-body",addClass=$this.attr("data-preview-class")||"post",prepend=$this.attr("data-prepend")||".post-edit";$post.loading(),$post.find(".preview").remove(),$.post($form.attr("action"),form,function(data){var $preview="*"!==preClass?$(data).find("."+preClass):$(data);$preview.removeClass(preClass).addClass("preview "+addClass).find(".ago").remove(),$post.find(prepend).prepend($preview);var $header=$("#header");$("html, body").animate({scrollTop:$post.find(prepend).offset().top-($header?$header.height():0)},250),$post.loading(!0)})}),$(document).on("click","a.ajaxify",function(){var parent=$(this).attr("data-ajaxify-target");return $(this).closest("section, article, aside"+(parent?", "+parent:"")).ajaxify($(this).attr("href")),!1}),$(document).on("submit","form.ajaxify",function(){var $form=$(this);return $(this).closest("section, aside").ajaxify($form.attr("action"),$form.serialize(),$form.attr("method")),!1}),$(document).on("click","a.notification",function(){var parent=$(this).attr("data-ajaxify-target");return $(this).closest("section, article, aside"+(parent?", "+parent:"")).ajaxify($(this).attr("href"),null,"get",function(response){var notifications=$(response).find("li").length,$notifications=$("#visitor a.notifications");$notifications&&(notifications?$notifications.find("span").text(notifications):$notifications.remove())}),!1}),$(document).on("click","a.dialogify",function(e){e.preventDefault(),$(this).dialogify()}),$(document).on("keydown",function(event){if(void 0===event.target.type){var link;switch(event.which){case $.ui.keyCode.LEFT:link=$(".pager .previous:not(.disabled) a").first().attr("href");break;case $.ui.keyCode.RIGHT:link=$(".pager .next:not(.disabled) a").first().attr("href")}link&&(event.preventDefault(),window.location=link)}}),$("section.image-slideshow a[data-image-id]").on("click",function(){var $changes=$("a.image-change"),$image=$(this);$changes.length&&$changes.each(function(){var $link=$(this),change=$link.attr("data-change");$link.toggleClass("disabled",$image.hasClass(change)),$link.attr("href",$link.attr("href").replace(RegExp(change+".*$"),change+"="+$image.attr("data-image-id")))});var $delete=$("a.image-delete");$delete.length&&($delete.toggleClass("disabled",$(this).hasClass("default")),$delete.attr("href",$delete.attr("href").replace(/delete.*$/,"delete="+$(this).attr("data-image-id"))))}),$(".carousel").carousel({interval:!1}),$("img.lazy").lazyload({failure_limit:100}),$("a.notifications").on("click",function(){var $this=$(this);return $.get($this.attr("href"),function(response){$this.off("click").popover({content:response,html:!0,placement:"bottom",trigger:"click"}).popover("show")}),!1})}),function($){$.fn.hint=function(blurClass){return"placeholder"in document.createElement("input")?void 0:(blurClass=blurClass||"blur",this.each(function(){function remove(){isPassword?($password.remove(),$input.show()):$input.val()===placeholder&&$input.hasClass(blurClass)&&$input.val("").removeClass(blurClass)}var $input=$(this),placeholder=$input.attr("placeholder"),isPassword="password"==$input.attr("type"),$form=$(this.form),$win=$(window);if(placeholder){if(isPassword){$input.attr("placeholder",null);var $password=$input.clone(),display=$input.css("display");$password.hide().attr({type:"text",id:this.id+"-hint",name:$input.attr("name")+"-hint"}).addClass(blurClass).val(placeholder).insertAfter($input).focus(function(){$password.hide(),$input.show().focus()}),$input.blur(function(){""===this.value&&($input.hide(),$password.css("display",display))}),""===$input.val()&&($input.hide(),$password.css("display",display))}else $input.blur(function(){""===this.value&&$input.addClass(blurClass).val(placeholder)}).focus(remove).blur();$form.submit(remove),$win.unload(remove)}}))}}(jQuery),function($){$.fn.googleMap=function(options){var defaults={lat:60.1695,"long":24.9355,zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP,marker:!1,infowindow:!1,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}};if(options=$.extend(defaults,options||{}),options.city){var geocoder=new google.maps.Geocoder,geocode=(options.address?options.address+", ":"")+options.city;geocoder.geocode({address:geocode},function(results,status){status==google.maps.GeocoderStatus.OK&&results.length&&(options.lat=results[0].geometry.location.lat(),options.long=results[0].geometry.location.lng(),options.marker=!0)})}var center=new google.maps.LatLng(options.lat,options.long),map=new google.maps.Map(this.get(0),$.extend(options,{center:center}));if(options.marker){var marker=new google.maps.Marker({position:center,map:map,title:options.marker?"":options.marker});if(options.infowindow){var infowindow=new google.maps.InfoWindow({content:options.infowindow});google.maps.event.addListener(marker,"click",function(){infowindow.open(map,marker)})}}}}(jQuery),function($){$.fn.dialogify=function(){var href=this.attr("href")||this.attr("data-href");if(!href)return!1;var title=this.attr("data-dialog-title"),width=this.attr("data-dialog-width")||300,height=this.attr("data-dialog-height")||"auto";return $('<div style="display:none"></div>').appendTo("body").dialog({modal:!0,title:title,width:width,height:height,closeText:"☓",open:function(){$(this).load(href)},close:function(){$(this).remove()}}),!1}}(jQuery),function($){$.fn.ajaxify=function(url,data,type,success){var $target=$(this);return type="post"==type||"POST"==type?"POST":"GET",$.ajax({type:type,url:url,data:data,timeout:2500,success:function(data){$target.slideUp("fast",function(){$target.replaceWith(data).slideDown("fast")}),"function"==typeof success&&success(data)},error:function(req,err){"error"===err&&(err=req.statusText),alert("Fail: "+err),$target.loading(!0)},beforeSend:function(){$target.loading()}}),this}}(jQuery),function($,Anqh){$.fn.autocompleteEvent=function(options){var lastXhr,field=$(this),cache={},defaults={eventId:"event_id",limit:25,minLength:3,action:"form",search:"name",field:"id:name:city:stamp_begin:url",order:"stamp_begin.desc",position:{collision:"fit"}};options=$.extend(defaults,options||{}),$(this).autocomplete({minLength:options.minLength,position:options.position,source:function(request,response){return request.term in cache?(response(cache[request.term]),void 0):(lastXhr=$.ajax({url:Anqh.APIURL+"/v1/events/search",dataType:"jsonp",data:{q:request.term,limit:25,filter:options.filter,search:options.search,field:options.field,order:options.order},success:function(data,status,xhr){cache[request.term]=$.map(data.events,function(item){return{label:item.name,stamp:item.stamp_begin,city:item.city,value:item.name,id:item.id,url:item.url}}),xhr===lastXhr&&response(cache[request.term])}}),void 0)},select:function(event,ui){switch(options.action){case"form":$("input[name="+options.eventId+"]")&&$("input[name="+options.eventId+"]").val(ui.item.id),field.val(ui.item.value);break;case"redirect":window.location=ui.item.url;break;default:"function"==typeof options.action&&options.action(event,ui)}}}).data("autocomplete")._renderItem=function(ul,item){return $("<li></li>").data("item.autocomplete",item).append("<a>"+$.datepicker.formatDate("dd.mm.yy",new Date(1e3*item.stamp))+" "+item.label+", "+item.city+"</a>").appendTo(ul)}}}(jQuery,Anqh),function($){$.fn.autocompleteGeo=function(options){var defaults={map:"map",country:"fi",lang:"en",latitude:"latitude",longitude:"longitude",limit:10,minLength:3,type:"locality"};options=$.extend(defaults,options||{});var geocoder,autocomplete=$(this).autocomplete({minLength:options.minLength,source:function(request,response){geocoder||(geocoder=new google.maps.Geocoder),geocoder.geocode({address:request.term,region:options.country},function(results,status){if(status==google.maps.GeocoderStatus.OK){var count=0;response($.map(results,function(item){if(options.limit>count&&item.types.indexOf(options.type)>-1){count++;var place=item.formatted_address.split(",");return{label:item.formatted_address,value:place[0].replace(/^[\d ]+/,""),city:place.shift(),description:place.join(","),latitude:item.geometry.location.lat(),longitude:item.geometry.location.lng()}}}))}})},select:function(event,ui){$("input[name="+options.latitude+"]").val(ui.item.latitude),$("input[name="+options.longitude+"]").val(ui.item.longitude)}}).data("autocomplete");autocomplete._renderItem=function(ul,item){var $map=$("<img />").attr({width:100,height:100,alt:"Google Maps",src:"http://maps.googleapis.com/maps/api/staticmap?center="+item.latitude+","+item.longitude+"&zoom=10&size=100x100&sensor=false"});return $('<li class="geocoded" />').data("item.autocomplete",item).append("<a><strong>"+item.city+"</strong><br />"+item.description+"</a>").append($map).appendTo(ul)},autocomplete._renderMenu=function(ul,items){ul.addClass("geocoded");var self=this;$.each(items,function(index,item){self._renderItem(ul,item)})}}}(jQuery),function($,Anqh){$.fn.autocompleteUser=function(options){function split(val){return val.split(/,\s*/)}function lastTerm(term){return split(term).pop()}var lastXhr,$field=$(this),cache={},defaults={user:0,userId:"user_id",limit:15,minLength:2,maxUsers:1,tokenized:!1,action:"form",search:"username",field:"id:username:avatar:url",order:"username.asc",position:{collision:"fit"}};if(options=$.extend(defaults,options||{}),options.tokenized){var width=$field.width();$field.wrap('<div class="tokenized" />'),$field.parent().width(width).click(function(){$field.focus()})}var multiple=options.maxUsers>1&&!options.tokenized;$(this).autocomplete({minLength:options.minLength,position:options.position,source:function(request,response){var term=multiple?lastTerm(request.term):request.term;return term in cache?(response(cache[term]),void 0):(lastXhr=$.ajax({url:Anqh.APIURL+"/v1/users/search",dataType:"jsonp",data:{q:term,user:options.user,limit:options.limit,field:options.field,order:options.order},success:function(data,status,xhr){cache[term]=$.map(data.users,function(item){return{label:item.username,value:item.username,image:item.avatar,id:item.id,url:item.url}}),xhr===lastXhr&&response(cache[term])}}),void 0)},search:function(){if(multiple){var terms=split(this.value);if(terms.length>options.maxUsers||terms.pop().length<this.minLength)return!1}},focus:function(){return multiple?!1:void 0},select:function(event,ui){switch(options.action){case"form":if(multiple){var terms=split(this.value);return terms.pop(),terms.push(ui.item.value),terms.push(""),this.value=terms.join(", "),!1}if(options.maxUsers>1){var span=$("<span>").attr({"user-id":ui.item.id}).text(ui.item.value);return $("<a>").attr({href:"#remove"}).text("x").click(function(){return $(this).parent().remove(),!1}).appendTo(span),span.insertBefore(field),this.value="",!1}$("input[name="+options.userId+"]")&&$("input[name="+options.userId+"]").val(ui.item.id),$field.val(ui.item.value);break;case"redirect":var location=$field.attr("data-redirect")||ui.item.url;$.each(ui.item,function(key,value){location=location.replace(":"+key,value)}),window.location=location;break;default:"function"==typeof options.action&&options.action(event,ui)}}}).data("autocomplete")._renderItem=function(ul,item){return $("<li></li>").data("item.autocomplete",item).append("<a>"+(item.image?'<img src="'+item.image+'" alt="Avatar" width="22" height="22" align="middle" />':"")+item.label+"</a>").appendTo(ul)}}}(jQuery,Anqh),function($,Anqh){$.fn.autocompleteVenue=function(){},$.fn.autocompleteVenue=function(options){var $field=$(this),defaults={venueId:"venue_id",cityName:"city_name",latitude:"latitude",longitude:"longitude",limit:25,minLength:1,action:"form",source:[],position:{collision:"fit"}};options=$.extend(defaults,options||{}),$(this).autocomplete({minLength:options.minLength,position:options.position,source:options.source,select:function(event,ui){switch(options.action){case"form":$("input[name="+options.venueId+"]")&&$("input[name="+options.venueId+"]").val(ui.item.id),$("input[name="+options.cityName+"]")&&$("input[name="+options.cityName+"]").val(ui.item.city),$("input[name="+options.latitude+"]")&&$("input[name="+options.latitude+"]").val(ui.item.latitude),$("input[name="+options.longitude+"]")&&$("input[name="+options.longitude+"]").val(ui.item.longitude),$field.val(ui.item.value);break;case"redirect":window.location=ui.item.url;break;default:"function"==typeof options.action&&options.action(event,ui)}}}).data("autocomplete")._renderItem=function(ul,item){return $("<li></li>").data("item.autocomplete",item).append("<a>"+item.label+", "+item.city+"</a>").appendTo(ul)}},$.fn.foursquareVenue=function(options){var defaults={address:"address",latitudeSearch:"city_latitude",longitudeSearch:"city_longitude",latitude:"latitude",longitude:"longitude",venueId:"venue_id",categoryId:"category_id",map:"map",limit:10,position:{collision:"fit"}};options=$.extend(defaults,options||{}),$(this).autocomplete({minLength:2,position:options.position,source:function(request,response){$.ajax({url:Anqh.APIURL+"/v1/venues/foursquare",dataType:"jsonp",type:"get",data:{method:"venues",ll:$("input[name="+options.latitudeSearch+"]").val()+","+$("input[name="+options.longitudeSearch+"]").val(),limit:options.limit,intent:"match",query:request.term},success:function(data){return data.venues?(response($.map(data.venues.groups[0].venues,function(item){return{id:item.id,label:item.name+", "+item.address,value:item.name,address:item.address,city:item.city,zip:item.zip,lat:item.geolat,"long":item.geolong,category:item.primarycategory?item.primarycategory.id:0}})),void 0):!1}})},select:function(event,ui){$("input[name="+options.venueId+"]")&&$("input[name="+options.venueId+"]").val(ui.item.id),ui.item.category&&$("input[name="+options.categoryId+"]")&&$("input[name="+options.categoryId+"]").val(ui.item.category),ui.item.address&&$("input[name="+options.address+"]")&&$("input[name="+options.address+"]").val(ui.item.address),$("input[name="+options.latitude+"]")&&$("input[name="+options.latitude+"]").val(ui.item.lat),$("input[name="+options.longitude+"]")&&$("input[name="+options.longitude+"]").val(ui.item.long),$("#"+options.map).googleMap({marker:!0,lat:ui.item.lat,"long":ui.item.long})}})}}(jQuery,Anqh),function($){$.fn.notes=function(n){function add(note_data){var scaleX=imageWidth/note_data.imageWidth||1,scaleY=imageHeight/note_data.imageHeight||1,noteX=parseInt(imageOffset.left)+parseInt(note_data.x),noteY=parseInt(imageOffset.top)+parseInt(note_data.y),$note=$('<div class="note" id="note-'+note_data.id+'" />').css({left:noteX*scaleX+"px",top:noteY*scaleY+"px"}),$area=$('<div class="notea" />').css({width:note_data.width*scaleX+"px",height:note_data.height*scaleY+"px"}),$text=$('<div class="notet label label-inverse" />').append(note_data.url?$('<a href="'+note_data.url+'" class="hoverable">'+note_data.name+"</a>"):note_data.name);$note.append($area).append($text),$image.after($note),$("[data-note-id="+note_data.id+"]")&&$("[data-note-id="+note_data.id+"]").hover(function(){$area.css({visibility:"visible"})},function(){$area.css({visibility:"hidden"})})}var notes=n||{},$image=$(this),imageOffset=$image.position(),imageWidth=$image.width(),imageHeight=$image.height();$(notes).each(function(){add(this)}),$(window).resize(function(){$(".note").remove(),imageOffset=$image.position(),imageWidth=$image.width(),imageHeight=$image.height(),$(notes).each(function(){add(this)})})}}(jQuery);